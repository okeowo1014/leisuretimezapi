from rest_framework import serializers
from .models import Package, PackageImage, GuestImage, CustomerProfile, Booking, Locations

class PackageSerializer(serializers.ModelSerializer):
    class Meta:
        model = Package
        fields = ['package_id', 'name', 'category', 'status', 'price', 'description']

class PackageImageSerializer(serializers.ModelSerializer):
    class Meta:
        model = PackageImage
        fields = ['image', 'package']

class GuestImageSerializer(serializers.ModelSerializer):
    class Meta:
        model = GuestImage
        fields = ['image', 'package']

class CustomerProfileSerializer(serializers.ModelSerializer):
    class Meta:
        model = CustomerProfile
        fields = ['user', 'full_name', 'phone', 'address']

class BookingSerializer(serializers.ModelSerializer):
    class Meta:
        model = Booking
        fields = ['id', 'customer', 'package', 'status', 'booking_date']

class LocationSerializer(serializers.ModelSerializer):
    class Meta:
        model = Locations
        fields = ['title', 'type', 'city', 'state', 'country']

from django.shortcuts import get_object_or_404
from django.db.models import Q
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework import status, permissions
from .models import Package, PackageImage, GuestImage, CustomerProfile, Booking, Locations
from .serializers import (
    PackageSerializer, PackageImageSerializer, GuestImageSerializer,
    CustomerProfileSerializer, BookingSerializer, LocationSerializer
)

class PackageListAPIView(APIView):
    """ Fetch all active packages """
    def get(self, request):
        packages = Package.objects.filter(status='active').order_by('-id', 'category')
        serializer = PackageSerializer(packages, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)

class PackageDetailAPIView(APIView):
    """ Fetch package details along with images """
    def get(self, request, pid):
        package = get_object_or_404(Package, package_id=pid)
        package_images = PackageImage.objects.filter(package=package)
        guest_images = GuestImage.objects.filter(package=package)

        package_data = PackageSerializer(package).data
        package_data['images'] = PackageImageSerializer(package_images, many=True).data
        package_data['guest_images'] = GuestImageSerializer(guest_images, many=True).data

        return Response(package_data, status=status.HTTP_200_OK)

class PersonalBookingAPIView(APIView):
    """ Get the authenticated user's booking profile """
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        try:
            profile = CustomerProfile.objects.get(user=request.user)
            serializer = CustomerProfileSerializer(profile)
            return Response(serializer.data, status=status.HTTP_200_OK)
        except CustomerProfile.DoesNotExist:
            return Response({"error": "Profile not found"}, status=status.HTTP_404_NOT_FOUND)

class BookingHistoryAPIView(APIView):
    """ Fetch booking history for authenticated user """
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        history = Booking.objects.filter(customer__user=request.user)
        serializer = BookingSerializer(history, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)

class SearchLocationsAPIView(APIView):
    """ Search locations based on filters """
    def get(self, request):
        country = request.GET.get('country')
        states = request.GET.get('state', '').split('-')
        location_type = request.GET.get('type')

        if not country or not states or not location_type:
            return Response({"error": "Invalid parameters"}, status=status.HTTP_400_BAD_REQUEST)

        state_queries = Q()
        for state in states:
            state_queries |= Q(state__icontains=state)

        locations = Locations.objects.filter(
            Q(country__iexact=country) & state_queries & Q(type__iexact=location_type)
        )

        serializer = LocationSerializer(locations, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)
from django.urls import path
from .views import (
    PackageListAPIView, PackageDetailAPIView, PersonalBookingAPIView,
    BookingHistoryAPIView, SearchLocationsAPIView
)

urlpatterns = [
    path('packages/', PackageListAPIView.as_view(), name='package-list'),
    path('packages/<str:pid>/', PackageDetailAPIView.as_view(), name='package-detail'),
    path('personal-booking/', PersonalBookingAPIView.as_view(), name='personal-booking'),
    path('booking-history/', BookingHistoryAPIView.as_view(), name='booking-history'),
    path('search-locations/', SearchLocationsAPIView.as_view(), name='search-locations'),
]
